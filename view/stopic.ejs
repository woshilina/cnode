
<!-- 单篇文章页 -->

<%-include header%>
  <div class="d-flex justify-content-center">
    <div class="col-9 my-2">
      <div class="bg-white card">
        <div class="p-2 card-body ">
          <h3 class="title">
            <%= topics.title%>
          </h3>
          <div>
            <div>
              <small class="ml-1">
                <sapn class="mx-1">
                  发布于
                  <%=ttime[0]%>
                    </span>
                    <span>作者
                      <%= topics.username%>
                    </span>
                    <span>
                      <%=topics.clicks%>次浏览</span>
                    <span>最后一次编辑是
                      <%=ttime[1]%>
                    </span>
                    <span>来自
                      <%= topics.tabValue%>
                    </span>
              </small>
              <button class="btn btn-success float-right" id="collect">收藏</button>
            </div>
            <%if(session&&topics.username==session.name){%>
              <a href="<%=topics.id%>/edit">
                <button class="edit btn btn-primary btn-sm"> 编辑 </button>
              </a>
              <button class="btn btn-danger btn-sm" class="delete ">删除</button>
              <%}%>

          </div>
        </div>
        <hr class="m-0">
        <div class="  p-2  card-body" id="text">
          <%= topics.text%>
        </div>
        <span class="success"></span>
      </div>
      <% if(replys!=0){%>
        <div class="bg-white mt-2 card">
          <p class="card-header">回复</p>
          <div class="list-group card-body p-0">
            <% replys.forEach(function(res,index){ %>
              <div class="list-group-item py-0 ">
                <p class="rep_content">
                  <form class="rep_name" action="/topic/<%=topics.id%>/like" method="post">
                    <%= res['name'] %>
                      <small class="text-primary">
                        <%=index+1%>楼</small>
                      <small class="text-primary">
                        <%=res['replyfromnow']%>
                      </small>
                      <!-- 登陆且与评论者为同一人 -->
                      <% if(session && session.name == res['name']){ %>
                        <div class="float-right">
                          <button id='slike' type="button" value="<%=res['id']%>" class="btn btn-info  btn-sm"> 点赞</button>
                          <span>
                            <%=res['likes']%>
                          </span>
                          <button id='sedit' type="button" value="<%=res['id']%>" class="btn btn-info  btn-sm">
                            <a href="/reply/<%=res['id']%>/edit">编辑</a>
                          </button>
                          <button id='sdelete' type="button" value="<%=res['id']%>" class="btn btn-info  btn-sm">删除</button>
                          <button id='sreply' type="button" value="<%=res['id']%>" class="btn btn-info  btn-sm" data-toggle="collapse" data-target="#srep<%=res['id']%>"
                            aria-expanded="false" aria-controls="srep<%=res['id']%>">回复</button>
                        </div>
                        <%}%>
                          <!-- 如果没登陆 -->
                          <!-- <%if(!session){%>
                            <div class="float-right">
                              <button id='nlike' type="button" value="<%=res['id']%>" class="btn btn-info  btn-sm">点赞</button>
                              <span>
                                <%=res['likes']%>
                              </span>
                            </div>
                            <%}%> -->
                          <!-- 登陆但与作者不是同一个人 -->
                          <% if(session&&session.name != res['name']){ %>

                            <!--如果登陆者对此评论点赞了  -->
                            <%if(likes[index]!=0){%>
                              <div class="float-right">
                                <button id='like' type="button" value="<%=res['id']%>" class="btn btn-success  btn-sm">点赞</button>
                                <span>
                                  <%=res['likes']%>
                                </span>
                                <button id='sreply' type="button" value="<%=res['id']%>" class="btn btn-info  btn-sm" data-toggle="collapse" data-target="#srep<%=res['id']%>"
                                  aria-expanded="false" aria-controls="srep<%=res['id']%>">回复</button>
                              </div>
                              <%}%>
                              <!-- 如果登陆者没有对此评论点赞 -->
                                <%if(likes[index]==0){%>
                                  <div class="float-right">
                                    <button id='like' type="button" value="<%=res['id']%>" class="btn btn-info  btn-sm">点赞</button>
                                    <span>
                                      <%=res['likes']%>
                                    </span>
                                    <button id='sreply' type="button" value="<%=res['id']%>" class="btn btn-info  btn-sm" data-toggle="collapse" data-target="#srep<%=res['id']%>"
                                      aria-expanded="false" aria-controls="srep<%=res['id']%>">回复</button>
                                  </div>
                                  <%}%>

                                    <%}%>
                                      <br/>
                                      <%= res['content'] %>
                                        <div class="bg-white collapse" id="srep<%=res['id']%>">
                                          <textarea class='w-100' id="stext" rows='7'>@<%=res['name']%>                                           
                                          </textarea>
                                          <button id='sre' type="button" class="btn btn-info  btn-sm">回复</button>
                                          <span class="suc"></span>
                                        </div>
                  </form>
                </p>
              </div>
              <%})%>
          </div>
        </div>
        <%}%>
          <%if(session&&session.id){%>
            <div class="bg-white mt-2 card">
              <p class="card-header">添加回复</p>
              <div class="card-body p-0">
                <textarea class="w-100 reply border-0 p-0"></textarea>
                <button class="btn btn-primary ml-3 mb-3" id="reply">回复</button>
                <span class="succ"></span>
              </div>
            </div>
            <%}%>
    </div>
    <div class="col-2.5 my-2">
      <div class='card bg-white  mb-3'>
        <div class='card-header'>
          作者
        </div>
        <div class='card-body'>
          <div class='user_card'>
            <div>
              <a class='user_avatar' href="/user/<%=topics.username%>">
                <img src="/images/7081645.png" width="30" height="30" alt="Generic placeholder image" />
              </a>
              <span class='user_'>
                <a class='dark' href="/user/<%=topics.username%>">
                  <%= topics.username %>
                </a>
              </span>

              <div class='board clearfix'>
                <div class='floor'>
                  <span class='big'>积分:
                    <%=session.integral%>
                  </span>
                </div>
              </div>
              <div class="space clearfix"></div>
              <%if(session.sign==null){%>
                <span class="signature">
                  “这家伙很懒，什么个性签名都没有留下。”
                </span>
                <%}%>
                  <%if(session.sign!=null){%>
                    <span class="signature">
                      <%=session.sign%>
                    </span>
                    <%}%>
            </div>
          </div>
        </div>
      </div>
      <%if(stopics){%>
        <div class="mt-3">
          <ul class="list-group">
            <li class="list-group-item">作者其他话题</li>
            <%stopics.forEach(function(res){%>
              <%if(res['id']!=topics.id){%>
                <li class="list-group-item">
                  <a href="/topic/<%=res['id']%>" class="text-muted">
                    <%=res['title']%>
                  </a>
                </li>
                <%}%>
                  <%})%>
          </ul>
        </div>
        <%}%>
    </div>
  </div>
  <%-include footer%>
    <script>
      // 删除文章
      $('.delete').click(() => {
        $.ajax({
          url: '/topic/<%=topics.id%>/delete',
          type: "GET",
          cache: false,
          dataType: 'json',
          success: function (msg) {
            if (msg) {
              $('.success').text('删除成功');
              setTimeout(() => {
                window.location.href = "/home"
              }, 1000)
            }
          },
          error: function () {
            alert('异常');
          }
        })
      });
      // 添加评论/回复
      $('#reply').click(function () {
        var cont = $('.reply').val();
        if (cont) {
          $.ajax({
            url: document.url,
            data: {
              content: $('.reply').val()
            },
            type: "POST",
            cache: false,
            dataType: 'json',
            success: function (msg) {
              if (msg) {
                $('.succ').text('回复成功');
                setTimeout(() => {
                  window.location.reload();
                }, 1000)
              }
            },
            error: function () {
              alert('异常');
            }
          });
        } else {
          $('.succ').text('填写回复内容后  才能提交哦！');
        }
      });

      //点赞+取消赞
      $(document).ready(function () {
        $("button[id='like']").each(function () {
          $(this).on('click', function () {
            var at = $(this).attr("value");
            var likes = parseInt($(this).next().text());
            if ($(this).hasClass('btn btn-success')) {
              $.ajax({
                url: document.URL + '/unlike',
                type: "POST",
                cache: false,
                data: {
                  att: at
                },
                dataType: 'json',
                error: function () {
                  alert('异常');
                }
              });
              $(this).next().text(likes - 1);
              $(this).removeClass('btn btn-success');
              $(this).addClass("btn btn-info");
            } else {
              $.ajax({
                url: document.URL + '/like',
                type: "POST",
                cache: false,
                data: {
                  att: at
                },
                dataType: 'json',
                error: function () {
                  alert('异常');
                }
              });
              $(this).next().text(likes + 1);
              $(this).removeClass('btn btn-info');
              $(this).addClass("btn btn-success");
            }
          })
        });

        $("button[id='slike']").each(function () {
          $(this).click(() => {
            alert("不可以为自己点赞哦")
          })
        });
      });

      // 删除评论
      $(document).ready(function () {
        $("button[id='sdelete']").each(function () {
          $(this).on('click', function () {
            var r = confirm("确定要删除此回复吗？");
            if (r == true) {
              var at = $(this).attr("value");
              $.ajax({
                url: '/reply/' + at + '/delete',
                type: "GET",
                cache: false,
                dataType: 'json',
                success: function (msg) {
                  location.reload();
                },
                error: function () {
                  alert('异常');
                }
              });
            }
          })
        });
      });

      //回复评论
      $(document).ready(function () {
        $("button[id='sre']").each(function () {
          $(this).on('click', function () {
            var text = $(this).prev().val();
            $.ajax({
              url: document.url,
              type: "POST",
              cache: false,
              data: {
                content: text
              },
              dataType: 'json',
              success: function (msg) {
                if (msg) {
                  $('.suc').text('回复成功');
                  setTimeout(() => {
                    window.location.reload();
                  }, 1000)
                }
              },
              error: function () {
                alert('异常');
              }
            });
          })
        });
      });
      // 未登录点赞
      $(document).ready(function () {
        $("button[id='nlike']").each(function () {
          $(this).on('click', function () {
            alert('请先登录，登录后即可点赞！');
            setTimeout(() => {
              window.location.href = '/onload';
            }, 1000)
          })
        });
      });
    </script>